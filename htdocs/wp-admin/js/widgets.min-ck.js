var wpWidgets;!function(e){wpWidgets={init:function(){var t,n,r=e("div.widgets-sortables"),i=isRtl?"marginRight":"marginLeft";e("#widgets-right").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){var t=e(this).siblings(".widgets-sortables"),n=e(this).parent();n.hasClass("closed")?(n.removeClass("closed"),t.sortable("enable").sortable("refresh")):(t.sortable("disable"),n.addClass("closed"))}),e("#widgets-left").children(".widgets-holder-wrap").children(".sidebar-name").click(function(){e(this).parent().toggleClass("closed")}),r.each(function(){if(e(this).parent().hasClass("inactive"))return!0;var t=50,n=e(this).children(".widget").length;t+=parseInt(48*n,10),e(this).css("minHeight",t+"px")}),e(document.body).bind("click.widgets-toggle",function(t){var n,r,s,o=e(t.target),u={};o.parents(".widget-top").length&&!o.parents("#available-widgets").length?(n=o.closest("div.widget"),r=n.children(".widget-inside"),s=parseInt(n.find("input.widget-width").val(),10),r.is(":hidden")?(s>250&&r.closest("div.widgets-sortables").length&&(u.width=s+30+"px",r.closest("div.widget-liquid-right").length&&(u[i]=235-s+"px"),n.css(u)),wpWidgets.fixLabels(n),r.slideDown("fast")):r.slideUp("fast",function(){n.css({width:"",margin:""})}),t.preventDefault()):o.hasClass("widget-control-save")?(wpWidgets.save(o.closest("div.widget"),0,1,0),t.preventDefault()):o.hasClass("widget-control-remove")?(wpWidgets.save(o.closest("div.widget"),1,1,0),t.preventDefault()):o.hasClass("widget-control-close")&&(wpWidgets.close(o.closest("div.widget")),t.preventDefault())}),r.children(".widget").each(function(){wpWidgets.appendTitle(this),e("p.widget-error",this).length&&e("a.widget-action",this).click()}),e("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"document",start:function(e,t){t.helper.find("div.widget-description").hide(),n=this.id},stop:function(){t&&e(t).hide(),t=""}}),r.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"document",start:function(e,t){t.item.children(".widget-inside").hide(),t.item.css({margin:"",width:""})},stop:function(r,i){if(i.item.hasClass("ui-draggable")&&i.item.data("draggable")&&i.item.draggable("destroy"),i.item.hasClass("deleting"))return wpWidgets.save(i.item,1,0,1),i.item.remove(),void 0;var s=i.item.find("input.add_new").val(),o=i.item.find("input.multi_number").val(),u=n,f=e(this).attr("id");return i.item.css({margin:"",width:""}),n="",s?("multi"==s?(i.item.html(i.item.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,o)})),i.item.attr("id",u.replace("__i__",o)),o++,e("div#"+u).find("input.multi_number").val(o)):"single"==s&&(i.item.attr("id","new-"+u),t="div#"+u),wpWidgets.save(i.item,0,0,1),i.item.find("input.add_new").val(""),i.item.find("a.widget-action").click(),void 0):(wpWidgets.saveOrder(f),void 0)},receive:function(t,n){var r=e(n.sender);e(this).is(":visible")&&-1==this.id.indexOf("orphaned_widgets")||r.sortable("cancel"),-1==r.attr("id").indexOf("orphaned_widgets")||r.children(".widget").length||r.parents(".orphan-sidebar").slideUp(400,function(){e(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables").parent().filter(".closed").children(".widgets-sortables").sortable("disable"),e("#available-widgets").droppable({tolerance:"pointer",accept:function(t){return"widget-list"!=e(t).parent().attr("id")},drop:function(t,n){n.draggable.addClass("deleting"),e("#removing-widget").hide().children("span").html("")},over:function(t,n){n.draggable.addClass("deleting"),e("div.widget-placeholder").hide(),n.draggable.hasClass("ui-sortable-helper")&&e("#removing-widget").show().children("span").html(n.draggable.find("div.widget-title").children("h4").html())},out:function(t,n){n.draggable.removeClass("deleting"),e("div.widget-placeholder").show(),e("#removing-widget").hide().children("span").html("")}})},saveOrder:function(t){t&&e("#"+t).closest("div.widgets-holder-wrap").find(".spinner").css("display","inline-block");var n={action:"widgets-order",savewidgets:e("#_wpnonce_widgets").val(),sidebars:[]};e("div.widgets-sortables").each(function(){e(this).sortable&&(n["sidebars["+e(this).attr("id")+"]"]=e(this).sortable("toArray").join(","))}),e.post(ajaxurl,n,function(){e(".spinner").hide()}),this.resize()},save:function(t,n,r,i){var s,o=t.closest("div.widgets-sortables").attr("id"),u=t.find("form").serialize();t=e(t),e(".spinner",t).show(),s={action:"save-widget",savewidgets:e("#_wpnonce_widgets").val(),sidebar:o},n&&(s.delete_widget=1),u+="&"+e.param(s),e.post(ajaxurl,u,function(s){var o;n?(e("input.widget_number",t).val()||(o=e("input.widget-id",t).val(),e("#available-widgets").find("input.widget-id").each(function(){e(this).val()==o&&e(this).closest("div.widget").show()})),r?(i=0,t.slideUp("fast",function(){e(this).remove(),wpWidgets.saveOrder()})):(t.remove(),wpWidgets.resize())):(e(".spinner").hide(),s&&s.length>2&&(e("div.widget-content",t).html(s),wpWidgets.appendTitle(t),wpWidgets.fixLabels(t))),i&&wpWidgets.saveOrder()})},appendTitle:function(t){var n=e('input[id*="-title"]',t).val()||"";n&&(n=": "+n.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),e(t).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(n)},resize:function(){e("div.widgets-sortables").each(function(){if(e(this).parent().hasClass("inactive"))return!0;var t=50,n=e(this).children(".widget").length;t+=parseInt(48*n,10),e(this).css("minHeight",t+"px")})},fixLabels:function(t){t.children(".widget-inside").find("label").each(function(){var t=e(this).attr("for");t&&t==e("input",this).attr("id")&&e(this).removeAttr("for")})},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.css({width:"",margin:""})})}},e(document).ready(function(){wpWidgets.init()})}(jQuery);