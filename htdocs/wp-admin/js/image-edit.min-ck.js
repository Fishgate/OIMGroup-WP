var imageEdit;!function(e){imageEdit={iasapi:{},hold:{},postid:"",intval:function(e){return 0|e},setDisabled:function(t,n){n?(t.removeClass("disabled"),e("input",t).removeAttr("disabled")):(t.addClass("disabled"),e("input",t).prop("disabled",!0))},init:function(t){var n=this,r=e("#image-editor-"+n.postid),i=n.intval(e("#imgedit-x-"+t).val()),s=n.intval(e("#imgedit-y-"+t).val());n.postid!=t&&r.length&&n.close(n.postid),n.hold.w=n.hold.ow=i,n.hold.h=n.hold.oh=s,n.hold.xy_ratio=i/s,n.hold.sizer=parseFloat(e("#imgedit-sizer-"+t).val()),n.postid=t,e("#imgedit-response-"+t).empty(),e('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var n=t.keyCode;return n>36&&41>n&&e(this).blur(),13==n?(t.preventDefault(),t.stopPropagation(),!1):void 0})},toggleEditor:function(t,n){var r=e("#imgedit-wait-"+t);n?r.height(e("#imgedit-panel-"+t).height()).fadeIn("fast"):r.fadeOut("fast")},toggleHelp:function(t){return e(t).siblings(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return e('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,n){var r=e("#imgedit-scale-width-"+t),i=e("#imgedit-scale-height-"+t),s=e("#imgedit-scale-warn-"+t),o="",u="";n?(u=""!=r.val()?Math.round(r.val()/this.hold.xy_ratio):"",i.val(u)):(o=""!=i.val()?Math.round(i.val()*this.hold.xy_ratio):"",r.val(o)),u&&u>this.hold.oh||o&&o>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden")},getSelRatio:function(t){var n=this.hold.w,r=this.hold.h,i=this.intval(e("#imgedit-crop-width-"+t).val()),s=this.intval(e("#imgedit-crop-height-"+t).val());return i&&s?i+":"+s:n&&r?n+":"+r:"1:1"},filterHistory:function(t,n){var r,i,s,o,u=e("#imgedit-history-"+t).val(),f=[];if(""!=u){if(u=JSON.parse(u),r=this.intval(e("#imgedit-undone-"+t).val()),r>0)for(;r>0;)u.pop(),r--;if(n){if(!u.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";s=u[u.length-1],s=s.c||s.r||s.f||!1,s&&(this.hold.w=s.fw,this.hold.h=s.fh)}for(i in u)o=u[i],o.hasOwnProperty("c")?f[i]={c:{x:o.c.x,y:o.c.y,w:o.c.w,h:o.c.h}}:o.hasOwnProperty("r")?f[i]={r:o.r.r}:o.hasOwnProperty("f")&&(f[i]={f:o.f.f});return JSON.stringify(f)}return""},refreshEditor:function(t,n,r){var i,s,o=this;o.toggleEditor(t,1),i={action:"imgedit-preview",_ajax_nonce:n,postid:t,history:o.filterHistory(t,1),rand:o.intval(1e6*Math.random())},s=e('<img id="image-preview-'+t+'" />').on("load",function(){var n,i,o=e("#imgedit-crop-"+t),u=imageEdit;o.empty().append(s),n=Math.max(u.hold.w,u.hold.h),i=Math.max(e(s).width(),e(s).height()),u.hold.sizer=n>i?i/n:1,u.initCrop(t,s,o),u.setCropSelection(t,0),"unknown"!=typeof r&&null!=r&&r(),e("#imgedit-history-"+t).val()&&0==e("#imgedit-undone-"+t).val()?e("input.imgedit-submit-btn","#imgedit-panel-"+t).removeAttr("disabled"):e("input.imgedit-submit-btn","#imgedit-panel-"+t).prop("disabled",!0),u.toggleEditor(t,0)}).on("error",function(){e("#imgedit-crop-"+t).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),o.toggleEditor(t,0)}).attr("src",ajaxurl+"?"+e.param(i))},action:function(t,n,r){var i,s,o,u,f,l=this;if(l.notsaved(t))return!1;if(i={action:"image-editor",_ajax_nonce:n,postid:t},"scale"==r){if(s=e("#imgedit-scale-width-"+t),o=e("#imgedit-scale-height-"+t),u=l.intval(s.val()),f=l.intval(o.val()),1>u)return s.focus(),!1;if(1>f)return o.focus(),!1;if(u==l.hold.ow||f==l.hold.oh)return!1;i["do"]="scale",i.fwidth=u,i.fheight=f}else{if("restore"!=r)return!1;i["do"]="restore"}l.toggleEditor(t,1),e.post(ajaxurl,i,function(n){e("#image-editor-"+t).empty().append(n),l.toggleEditor(t,0)})},save:function(t,n){var r,i=this.getTarget(t),s=this.filterHistory(t,0);return""==s?!1:(this.toggleEditor(t,1),r={action:"image-editor",_ajax_nonce:n,postid:t,history:s,target:i,context:e("#image-edit-context").length?e("#image-edit-context").val():null,"do":"save"},e.post(ajaxurl,r,function(n){var r=JSON.parse(n);return r.error?(e("#imgedit-response-"+t).html('<div class="error"><p>'+r.error+"</p><div>"),imageEdit.close(t),void 0):(r.fw&&r.fh&&e("#media-dims-"+t).html(r.fw+" &times; "+r.fh),r.thumbnail&&e(".thumbnail","#thumbnail-head-"+t).attr("src",""+r.thumbnail),r.msg&&e("#imgedit-response-"+t).html('<div class="updated"><p>'+r.msg+"</p></div>"),imageEdit.close(t),void 0)}),void 0)},open:function(t,n){var r,i=e("#image-editor-"+t),s=e("#media-head-"+t),o=e("#imgedit-open-btn-"+t),u=o.siblings(".spinner");o.prop("disabled",!0),u.show(),r={action:"image-editor",_ajax_nonce:n,postid:t,"do":"open"},i.load(ajaxurl,r,function(){i.fadeIn("fast"),s.fadeOut("fast",function(){o.removeAttr("disabled"),u.hide()})})},imgLoaded:function(t){var n=e("#image-preview-"+t),r=e("#imgedit-crop-"+t);this.initCrop(t,n,r),this.setCropSelection(t,0),this.toggleEditor(t,0)},initCrop:function(t,n,r){var i=this,s=e("#imgedit-sel-width-"+t),o=e("#imgedit-sel-height-"+t);i.iasapi=e(n).imgAreaSelect({parent:r,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(){r.children().mousedown(function(e){var n,r,s=!1;e.shiftKey&&(n=i.iasapi.getSelection(),r=i.getSelRatio(t),s=n&&n.width&&n.height?n.width+":"+n.height:r),i.iasapi.setOptions({aspectRatio:s})})},onSelectStart:function(){imageEdit.setDisabled(e("#imgedit-crop-sel-"+t),1)},onSelectEnd:function(e,n){imageEdit.setCropSelection(t,n)},onSelectChange:function(e,t){var n=imageEdit.hold.sizer;s.val(imageEdit.round(t.width/n)),o.val(imageEdit.round(t.height/n))}})},setCropSelection:function(t,n){var r,i=e("#imgedit-minthumb-"+t).val()||"128:128",s=this.hold.sizer;return i=i.split(":"),n=n||0,!n||n.width<3&&n.height<3?(this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0),this.setDisabled(e("#imgedit-crop-sel-"+t),0),e("#imgedit-sel-width-"+t).val(""),e("#imgedit-sel-height-"+t).val(""),e("#imgedit-selection-"+t).val(""),!1):n.width<i[0]*s&&n.height<i[1]*s?(this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),0),e("#imgedit-selection-"+t).val(""),!1):(r={x:n.x1,y:n.y1,w:n.width,h:n.height},this.setDisabled(e(".imgedit-crop","#imgedit-panel-"+t),1),e("#imgedit-selection-"+t).val(JSON.stringify(r)),void 0)},close:function(t,n){return n=n||!1,n&&this.notsaved(t)?!1:(this.iasapi={},this.hold={},e("#image-editor-"+t).fadeOut("fast",function(){e("#media-head-"+t).fadeIn("fast"),e(this).empty()}),void 0)},notsaved:function(t){var n=e("#imgedit-history-"+t).val(),r=""!=n?JSON.parse(n):new Array,i=this.intval(e("#imgedit-undone-"+t).val());return i<r.length?confirm(e("#imgedit-leaving-"+t).html())?!1:!0:!1},addStep:function(t,n,r){for(var i=this,s=e("#imgedit-history-"+n),o=""!=s.val()?JSON.parse(s.val()):new Array,u=e("#imgedit-undone-"+n),f=i.intval(u.val());f>0;)o.pop(),f--;u.val(0),o.push(t),s.val(JSON.stringify(o)),i.refreshEditor(n,r,function(){i.setDisabled(e("#image-undo-"+n),!0),i.setDisabled(e("#image-redo-"+n),!1)})},rotate:function(t,n,r,i){return e(i).hasClass("disabled")?!1:(this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},n,r),void 0)},flip:function(t,n,r,i){return e(i).hasClass("disabled")?!1:(this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},n,r),void 0)},crop:function(t,n,r){var i=e("#imgedit-selection-"+t).val(),s=this.intval(e("#imgedit-sel-width-"+t).val()),o=this.intval(e("#imgedit-sel-height-"+t).val());return e(r).hasClass("disabled")||""==i?!1:(i=JSON.parse(i),i.w>0&&i.h>0&&s>0&&o>0&&(i.fw=s,i.fh=o,this.addStep({c:i},t,n)),void 0)},undo:function(t,n){var r=this,i=e("#image-undo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())+1;i.hasClass("disabled")||(s.val(o),r.refreshEditor(t,n,function(){var n=e("#imgedit-history-"+t),s=""!=n.val()?JSON.parse(n.val()):new Array;r.setDisabled(e("#image-redo-"+t),!0),r.setDisabled(i,o<s.length)}))},redo:function(t,n){var r=this,i=e("#image-redo-"+t),s=e("#imgedit-undone-"+t),o=r.intval(s.val())-1;i.hasClass("disabled")||(s.val(o),r.refreshEditor(t,n,function(){r.setDisabled(e("#image-undo-"+t),!0),r.setDisabled(i,o>0)}))},setNumSelection:function(t){var n,r,i,s,o,u=e("#imgedit-sel-width-"+t),f=e("#imgedit-sel-height-"+t),l=this.intval(u.val()),c=this.intval(f.val()),h=e("#image-preview-"+t),p=h.height(),d=h.width(),v=this.hold.sizer,m=this.iasapi;return 1>l?(u.val(""),!1):1>c?(f.val(""),!1):(l&&c&&(n=m.getSelection())&&(s=n.x1+Math.round(l*v),o=n.y1+Math.round(c*v),r=n.x1,i=n.y1,s>d&&(r=0,s=d,u.val(Math.round(s/v))),o>p&&(i=0,o=p,f.val(Math.round(o/v))),m.setSelection(r,i,s,o),m.update(),this.setCropSelection(t,m.getSelection())),void 0)},round:function(e){var t;return e=Math.round(e),this.hold.sizer>.6?e:(t=e.toString().slice(-1),"1"==t?e-1:"9"==t?e+1:e)},setRatioSelection:function(t,n,r){var i,s,o=this.intval(e("#imgedit-crop-width-"+t).val()),u=this.intval(e("#imgedit-crop-height-"+t).val()),f=e("#image-preview-"+t).height();return this.intval(e(r).val())?(o&&u&&(this.iasapi.setOptions({aspectRatio:o+":"+u}),(i=this.iasapi.getSelection(!0))&&(s=Math.ceil(i.y1+(i.x2-i.x1)/(o/u)),s>f&&(s=f,n?e("#imgedit-crop-height-"+t).val(""):e("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(i.x1,i.y1,i.x2,s),this.iasapi.update())),void 0):(e(r).val(""),void 0)}}}(jQuery);