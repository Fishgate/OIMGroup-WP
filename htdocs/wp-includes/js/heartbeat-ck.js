/**
 * Heartbeat API
 *
 * Note: this API is "experimental" meaning it will likely change a lot
 * in the next few releases based on feedback from 3.6.0. If you intend
 * to use it, please follow the development closely.
 *
 * Heartbeat is a simple server polling API that sends XHR requests to
 * the server every 15 seconds and triggers events (or callbacks) upon
 * receiving data. Currently these 'ticks' handle transports for post locking,
 * login-expiration warnings, and related tasks while a user is logged in.
 *
 * Available filters in ajax-actions.php:
 * - heartbeat_received
 * - heartbeat_send
 * - heartbeat_tick
 * - heartbeat_nopriv_received
 * - heartbeat_nopriv_send
 * - heartbeat_nopriv_tick
 * @see wp_ajax_nopriv_heartbeat(), wp_ajax_heartbeat()
 *
 * @since 3.6.0
 */// Ensure the global `wp` object exists.
window.wp=window.wp||{};(function(e){var t=function(){function w(e){return e?parseInt((new Date).getTime()/1e3):(new Date).getTime()}function E(e){var t,n=e.src;if(n&&/^https?:\/\//.test(n)){t=window.location.origin?window.location.origin:window.location.protocol+"//"+window.location.host;if(n.indexOf(t)!==0)return!1}try{if(e.contentWindow.document)return!0}catch(r){}return!1}function S(n,r){var i;if(n){switch(n){case"abort":break;case"timeout":i=!0;break;case"parsererror":case"error":case"empty":case"unknown":h++;h>2&&(i=!0)}503==r&&!1===b&&(i=!0);if(i&&!t.hasConnectionError()){b=!0;e(document).trigger("heartbeat-connection-lost",[n,r])}}else if(t.hasConnectionError()){h=0;b=!1;e(document).trigger("heartbeat-connection-restored")}else null===b&&(b=!1)}function x(){var n={},r,o,c=!0,h=typeof window.heartbeatSettings=="object"?window.heartbeatSettings.nonce:"";u=w();r=e.extend({},a);a={};e(document).trigger("heartbeat-send",[r]);for(o in r)if(r.hasOwnProperty(o)){c=!1;break}if(c&&!t.hasConnectionError()){l=!1;T();return}n.data=r;n.interval=f/1e3;n._nonce=h;n.action="heartbeat";n.screen_id=i;n.has_focus=d;l=!0;t.xhr=e.ajax({url:s,type:"post",timeout:3e4,data:n,dataType:"json"}).done(function(n,r,i){var s;if(!n)return S("empty");t.hasConnectionError()&&S();if(n.nonces_expired){e(document).trigger("heartbeat-nonces-expired");return}if(n.heartbeat_interval){s=n.heartbeat_interval;delete n.heartbeat_interval}t.tick(n,r,i);s&&t.interval.call(t,s)}).always(function(){l=!1;T()}).fail(function(e,n,r){S(n||"unknown",e.status);t.error(e,n,r)})}function T(){var e=w()-u,t=f;if(!n)return;if(!d)t=1e5;else if(c>0&&p){t=p;c--}window.clearTimeout(r);e<t?r=window.setTimeout(function(){n&&x()},t-e):x()}function N(){window.clearTimeout(g);window.clearTimeout(y);g=y=0;d=!1}function C(){window.clearTimeout(g);window.clearTimeout(y);g=y=0;v=w();if(d)return;d=!0;window.clearTimeout(r);l||T()}function k(){e("iframe").each(function(t,n){if(!E(n))return;if(e.data(n,"wp-heartbeat-focus"))return;e.data(n,"wp-heartbeat-focus",1);e(n.contentWindow).on("focus.wp-heartbeat-focus",function(e){C()}).on("blur.wp-heartbeat-focus",function(e){k();y=window.setTimeout(function(){N()},500)})})}function L(){m=!1;e(document).off(".wp-heartbeat-active");e("iframe").each(function(t,n){if(!E(n))return;e(n.contentWindow).off(".wp-heartbeat-active")});C()}function A(){var t=v?w()-v:0;t>3e5&&d&&N();if(!m){e(document).on("mouseover.wp-heartbeat-active keyup.wp-heartbeat-active",function(){L()});e("iframe").each(function(t,n){if(!E(n))return;e(n.contentWindow).on("mouseover.wp-heartbeat-active keyup.wp-heartbeat-active",function(){L()})});m=!0}}var t=this,n,r,i=typeof pagenow!="undefined"?pagenow:"",s=typeof ajaxurl!="undefined"?ajaxurl:"",o,u=0,a={},f,l,c=0,h=0,p,d=!0,v,m,g,y=-1,b=null;this.hasConnectionError=function(){return!!b};if(typeof window.heartbeatSettings=="object"){o=e.extend({},window.heartbeatSettings);s=o.ajaxurl||s;delete o.ajaxurl;delete o.nonce;f=o.interval||15;delete o.interval;f<15?f=15:f>60&&(f=60);f*=1e3;i=i||o.screenId||"front";delete o.screenId;e.extend(this,o)}e(window).on("blur.wp-heartbeat-focus",function(e){k();g=window.setTimeout(function(){N()},500)}).on("focus.wp-heartbeat-focus",function(){e("iframe").each(function(t,n){if(!E(n))return;e.removeData(n,"wp-heartbeat-focus");e(n.contentWindow).off(".wp-heartbeat-focus")});C()});window.setInterval(function(){A()},3e4);e(document).ready(function(){n=!0;u=w();T()});this.hasFocus=function(){return d};this.interval=function(e,t){var n,r;t=parseInt(t,10)||30;t=t<1||t>30?30:t;if(e){switch(e){case"fast":r=5;c=t;break;case"slow":r=60;c=0;break;case"long-polling":f=0;return 0;default:r=15;c=0}n=r*1e3<f;if(c>0)p=r*1e3;else{f=r*1e3;p=0}n&&T()}return d?p?p/1e3:f/1e3:120};this.enqueue=function(e,t,n){if(e){if(n&&this.isQueued(e))return!1;a[e]=t;return!0}return!1};this.isQueued=function(e){if(e)return a.hasOwnProperty(e)};this.dequeue=function(e){e&&delete a[e]};this.getQueuedItem=function(e){if(e)return this.isQueued(e)?a[e]:undefined}};e.extend(t.prototype,{tick:function(t,n,r){e(document).trigger("heartbeat-tick",[t,n,r])},error:function(t,n,r){e(document).trigger("heartbeat-error",[t,n,r])}});wp.heartbeat=new t})(jQuery);