!function(){tinymce.create("tinymce.plugins.wpGallery",{init:function(e,t){var n=this;n.url=t,n.editor=e,n._createButtons(),e.addCommand("WP_Gallery",function(){tinymce.isIE&&e.selection.moveToBookmark(e.wpGalleryBookmark);var t,n=e.selection.getNode(),r=wp.media.gallery;"undefined"!=typeof wp&&wp.media&&wp.media.gallery&&"IMG"==n.nodeName&&-1!=e.dom.getAttrib(n,"class").indexOf("wp-gallery")&&(t=r.edit("["+e.dom.getAttrib(n,"title")+"]"),t.state("gallery-edit").on("update",function(t){var i=r.shortcode(t).string().slice(1,-1);e.dom.setAttrib(n,"title",i)}))}),e.onInit.add(function(e){"ontouchstart"in window&&e.dom.events.add(e.getBody(),"touchstart",function(t){var n=t.target;"IMG"==n.nodeName&&e.dom.hasClass(n,"wp-gallery")&&(e.selection.select(n),e.dom.events.cancel(t),e.plugins.wordpress._hideButtons(),e.plugins.wordpress._showButtons(n,"wp_gallerybtns"))})}),e.onMouseDown.add(function(e,t){"IMG"==t.target.nodeName&&e.dom.hasClass(t.target,"wp-gallery")&&(e.plugins.wordpress._hideButtons(),e.plugins.wordpress._showButtons(t.target,"wp_gallerybtns"))}),e.onBeforeSetContent.add(function(e,t){t.content=n._do_gallery(t.content)}),e.onPostProcess.add(function(e,t){t.get&&(t.content=n._get_gallery(t.content))})},_do_gallery:function(e){return e.replace(/\[gallery([^\]]*)\]/g,function(e,t){return'<img src="'+tinymce.baseURL+'/plugins/wpgallery/img/t.gif" class="wp-gallery mceItem" title="gallery'+tinymce.DOM.encode(t)+'" />'})},_get_gallery:function(e){function t(e,t){return t=(new RegExp(t+'="([^"]+)"',"g")).exec(e),t?tinymce.DOM.decode(t[1]):""}return e.replace(/(?:<p[^>]*>)*(<img[^>]+>)(?:<\/p>)*/g,function(e,n){var r=t(n,"class");return-1!=r.indexOf("wp-gallery")?"<p>["+tinymce.trim(t(n,"title"))+"]</p>":e})},_createButtons:function(){var e,t,n,r=this,i=tinymce.activeEditor,s=tinymce.DOM;s.get("wp_gallerybtns")||(n=window.devicePixelRatio&&window.devicePixelRatio>1||window.matchMedia&&window.matchMedia("(min-resolution:130dpi)").matches,s.add(document.body,"div",{id:"wp_gallerybtns",style:"display:none;"}),e=s.add("wp_gallerybtns","img",{src:n?r.url+"/img/edit-2x.png":r.url+"/img/edit.png",id:"wp_editgallery",width:"24",height:"24",title:i.getLang("wordpress.editgallery")}),tinymce.dom.Event.add(e,"mousedown",function(){var e=tinymce.activeEditor;e.wpGalleryBookmark=e.selection.getBookmark("simple"),e.execCommand("WP_Gallery"),e.plugins.wordpress._hideButtons()}),t=s.add("wp_gallerybtns","img",{src:n?r.url+"/img/delete-2x.png":r.url+"/img/delete.png",id:"wp_delgallery",width:"24",height:"24",title:i.getLang("wordpress.delgallery")}),tinymce.dom.Event.add(t,"mousedown",function(e){var t=tinymce.activeEditor,n=t.selection.getNode();"IMG"==n.nodeName&&t.dom.hasClass(n,"wp-gallery")&&(t.dom.remove(n),t.execCommand("mceRepaint"),t.dom.events.cancel(e)),t.plugins.wordpress._hideButtons()}))},getInfo:function(){return{longname:"Gallery Settings",author:"WordPress",authorurl:"http://wordpress.org",infourl:"",version:"1.0"}}}),tinymce.PluginManager.add("wpgallery",tinymce.plugins.wpGallery)}();